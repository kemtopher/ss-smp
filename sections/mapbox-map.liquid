{% schema %}
    {
      "name": "Mapbox Map",
      "settings": [
        {
          "type": "text",
          "id": "mapbox_api_key",
          "label": "Mapbox API Key",
          "info": "Enter your Mapbox API key"
        },
        {
          "type": "text",
          "id": "map_latitude",
          "label": "Default Latitude",
          "default": "40.7128"
        },
        {
          "type": "text",
          "id": "map_longitude",
          "label": "Default Longitude",
          "default": "-74.0060"
        },
        {
          "type": "text",
          "id": "map_zoom",
          "label": "Map Zoom Level",
          "default": "12"
        }
      ],
      "presets": [
        {
          "name": "Mapbox Map",
          "category": "Custom"
        }
      ]
    }
    {% endschema %}
    
    <div id="map" style="width: 100%; height: 400px;"></div>
    
    <script>
    document.addEventListener("DOMContentLoaded", () => {

        const fetchSellers = async () => {
            try {
                const res = await fetch("https://cdn.shopify.com/s/files/1/0723/2474/3380/files/sellers_cleaned.json?v=1741544199");

                if (!res.ok) {
                    throw new Error(`Failed to fetch: ${res.status}`);
                }

                return await res.json();
            } catch (error) {
                console.error("Error fetching sellers:", error);
                return [];
            }
        };

        const mapboxApiKey = "{{ section.settings.mapbox_api_key }}";
        const lat = parseFloat("{{ section.settings.map_latitude }}");
        const lng = parseFloat("{{ section.settings.map_longitude }}");
        const zoomLevel = parseInt("{{ section.settings.map_zoom }}", 10);

        if (!mapboxApiKey) {
            console.error("Mapbox API key is missing!");
            return;
        }

        const script = document.createElement("script");
        script.src = "https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js";
        script.onload = () => {
            mapboxgl.accessToken = mapboxApiKey;
            const map = new mapboxgl.Map({
                container: "map",
                style: "mapbox://styles/mapbox/streets-v11",
                center: [lng, lat],
                zoom: zoomLevel
            });

            (async () => {
                const sellers = await fetchSellers();

                const storeNames = sellers.map(seller => seller);
                console.log("Inside function: ", storeNames); 
            })();
            new mapboxgl.Marker().setLngLat([lng, lat]).addTo(map);
        };

        document.body.appendChild(script);
    });
    </script>
    
    <style>
    @import url('https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css');
    #map {
        border-radius: 10px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }
    </style>